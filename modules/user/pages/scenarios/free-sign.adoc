= Произвольное подписание

.Чтобы подписать электронной подписью карточку "Документ":
. Откройте карточку _Документ_, которую требуется подписать.
. На ленте карточки нажмите на кнопку:
+
--
* image:buttons/stamp-red-small.png[Маленькая красная печать с плюсом] -- чтобы выполнить подписание.
* *Подписать* -- чтобы дополнительно настроить подписание.
--
+
.Чтобы дополнительно настроить подписание:
.. Нажмите на кнопку *Подписать*.
+
.Меню кнопки "Подписать"
image::sign-button-menu.png[Меню кнопки "Подписать"]
+
.. Выберите команду *Варианты*. Будет открыто окно *Варианты подписи*.
.. В раскрывающемся списке _Метка_ выберите метку из числа доступных для вида. Настроить метки можно в _Справочнике меток подписей_.
.. В раскрывающемся списке _За кого_ выберите сотрудника, от имени которого будет подписана карточка.
+
Данное поле активно, если в _Справочнике сотрудников_ текущий пользователь указан хотя бы для одного сотрудника заместителем с правом подписи.
+
.. После выбора сотрудника (_За кого_) становится активным дополнительное поле _Текст подтверждения ЭЦП_. По умолчанию в поле подставляется доступное для изменения значение настройки _Текст подтверждения ЭЦП_, заданное в карточке сотрудника для соответствующего замещаемого.
+
.Настройка варианта подписи
image::sign-options.png[Настройка варианта подписи]
+
. [[three]]Выберите сертификат подписи и нажмите на кнопку *OK*, или нажмите на кнопку *Простая подпись*.
+
.Выбор сертификата ЭП при подписании
image::select-cert.png[Выбор сертификата ЭП при подписании]
+
.Окно выбора сертификата не отображается, если:
* У пользователя один сертификат и он указан в _Справочнике сотрудников_ -- будет использован этот сертификат.
* У пользователя нет сертификатов для подписания -- будет использована простая подпись.
* В _Справочнике сотрудников_ установлен параметр `*Не показывать окно выбора сертификата*`. В этом случае вместо окна выбора сертификата будет выдано сообщение: `Будет выполнено подписание с помощью сертификата`. После подтверждения операции подписания будет наложена усиленная электронная подпись с использованием указанного сертификата.
+
Если сертификат, указанный в _Справочнике сотрудников_, просрочен, или не удалось проверить его состояние, будет выдано сообщение: `Не удалось выполнить подписание с использованием сертификата. Сертификат недействителен или же его состояние не может быть проверено. Обратитесь к администратору системы` и подпись наложена не будет.
+
При подписании с помощью сертификата в зависимости от настроек системы {dv} и наличия на компьютере требуемого ПО формируется простая или усиленная подпись.

При подписании _основных_ файлов, приложенных к карточке, формируется одна подпись, в которую включается по отдельной части для каждого из основных файлов. Номер версии каждого основного файла отображается в его части подписи.

[IMPORTANT]
====
Со стандартными настройками в {dv} не поддерживается подписание сертификатом файлов с размером больше 35 Мб. При попытке подписать файл большего размера возникнет ошибка. Допустимый размер для подписываемых файлов может быть изменён администратором.
====

Если это предусмотрено настройками вида карточек, функция подписания вызывается автоматически при выполнении определённой операции с документом, при этом электронная подпись формируется в соответствии с настройками подписания, заданными для вида карточек в _Справочнике видов карточек_. При выполнении автоматического подписания будет выведен диалог выбора сертификата в соответствии с условиями, приведенными <<three,в пункте 3>>.

[#simple]
== Простая подпись

Наложить простую подпись может любой пользователь, который работает с системой {dv} с использованием учетной записи Windows.

При наложении будут подписаны атрибуты, входящие в состав подписи, а именно, настроенные для вида карточки атрибуты самого документа и атрибуты выполненной над документом операции редактирования. В зависимости от настроек, подписаны могут быть как основные, так и дополнительные файлы карточки.

Например, подпись может быть наложена при выполнении операции регистрации документа, для подтверждения конкретным сотрудником факта регистрации, с сохранением времени выполнения данной операции.

При выполнении экспорта документа, простая подпись (в отличие от усиленной) не может быть экспортирована.

[#strong]
== Усиленная подпись

Наложить усиленную подпись может пользователь, который имеет действующий сертификат подписи.

При наложении будут подписаны атрибуты, входящие в состав подписи, а именно, настроенные для вида карточки атрибуты самого документа и атрибуты выполненной над документом операции редактирования. В зависимости от настроек, подписаны могут быть как основные, так и дополнительные файлы карточки.

Документ с наложенной усиленной подписью может, При необходимости быть экспортирован в формат `.p7s`. Пользователю доступен выбор предпочтительного способа экспорта (в одном или в разных файлах с документом), а также выбор для экспортирования определённых подписей из числа доступных.

Файлы с наложенной подписью (сохраненные как в одном, так и в разных файлах) могут добавляться в качестве вложений в карточки документов. Подпись импортируется после дополнительного подтверждения со стороны пользователя. Если подписи сохранены в разных файлах, дополнительно выполняется проверка на соответствие файла документа и файла подписи.

Сертификат представляет собой электронный документ (файл) типа `.sc` (Security Certificate), который предназначен для связывания данных для проверки электронных подписей с определённым лицом и подтверждения идентичности данного лица.

Один пользователь системы {dv} может быть владельцем как одного, так и нескольких сертификатов подписи. Конкретный сертификат выбирает пользователь на этапе выполнения команды подписания непосредственно из карточки. Сертификат, используемый по умолчанию, должен быть указан в карточке сотрудника в _Справочнике сотрудников_.

.Сертификат подписи пользователя
image::signature-certificate.png[Сертификат подписи пользователя]

Проверка валидности обычного сертификата осуществляется по текущему времени клиента. Если срок действия сертификата на момент подписания истек, сертификат будет считаться недействующим. При попытке подписать документ в окне выбора сертификата подписи записи будут подсвечиваться розовым цветом, а кнопка *ОК* при выборе записи станет неактивной.

В системе _{dv}_ также могут использоваться квалифицированные сертификаты подписей с поддержкой стандартов TSP/OCSP. При наличии такого сертификата, в состав подписи, помимо настроенных в системе атрибутов, вместо времени клиента будет включен штамп времени, полученный от сервера _Службы штампов времени_.

В случае успешного подписания документа или операции, в соответствующем журнале будет прописываться как дата и время из запрошенного штампа, так и время выполнения операции подписания. Проверка валидности подписей стандарта TSP/OCSP осуществляется на момент времени, указанный в штампе, даже если срок сертификата на текущий момент истек.

Если на момент подписания сертификат был действующим, подпись будет считаться валидной даже после истечения срока действия сертификата (как обычного, так и с поддержкой стандартов TSP/OCSP). В журнале подписей будет отображена информация об окончании действия сертификата.
